
services:
  # 1. BAZA DE DATE
  postgres-db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-root}
    volumes:
      - ./postgres/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
      - db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - microservice-network
    deploy:
      replicas: 1
      placement:
        constraints: [node.role == manager] # Recomandat pentru DB să stea pe un nod stabil

  # 2. RABBITMQ
  rabbitmq:
    image: rabbitmq:3.12-management
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - microservice-network
    deploy:
      replicas: 1

  # 3. USER SERVICE
  user-service:
    image: tema1-user-service:latest # Numele imaginii construite local
    # build: ./user-service/demo  <-- ȘTERS (Swarm nu face build)
    depends_on:
      - postgres-db
    environment:
      DB_IP: postgres-db
      DB_PORT: 5432
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      DB_DBNAME: user_db
      PORT: 8080
    networks:
      - microservice-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels: # AICI E SCHIMBAREA MAJORĂ: Labels sub Deploy
        - "traefik.enable=true"
        - "traefik.http.routers.user-service.rule=PathPrefix(`/api/users`)"
        - "traefik.http.services.user-service.loadbalancer.server.port=8080"
        - "traefik.http.middlewares.strip-api.stripprefix.prefixes=/api"
        - "traefik.http.routers.user-service.middlewares=strip-api"

  # 4. DEVICE SERVICE
  device-service:
    image: tema1-device-service:latest
    depends_on:
      - postgres-db
    environment:
      DB_IP: postgres-db
      DB_PORT: 5432
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      DB_DBNAME: device_db
      PORT: 8081
    networks:
      - microservice-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.device-service.rule=PathPrefix(`/api/devices`)"
        - "traefik.http.services.device-service.loadbalancer.server.port=8081"
        - "traefik.http.routers.device-service.middlewares=strip-api"

  # 5. AUTH SERVICE
  auth-service:
    image: tema1-auth-service:latest
    depends_on:
      - postgres-db
    environment:
      DB_IP: postgres-db
      DB_PORT: 5432
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      DB_DBNAME: credential_db
      PORT: 8082
    networks:
      - microservice-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.auth-service.rule=PathPrefix(`/api/auth`)"
        - "traefik.http.services.auth-service.loadbalancer.server.port=8082"
        - "traefik.http.routers.auth-service.middlewares=strip-api"

  # 6. MONITORING SERVICE
  monitoring-service:
    image: tema1-monitoring-service:latest
    depends_on:
      - postgres-db
      - rabbitmq
    environment:
      DB_IP: postgres-db
      DB_PORT: 5432
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      DB_DBNAME: monitoring_db
      PORT: 8083
    networks:
      - microservice-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.monitoring-service.rule=PathPrefix(`/api/monitoring`)"
        - "traefik.http.services.monitoring-service.loadbalancer.server.port=8083"
        - "traefik.http.routers.monitoring-service.middlewares=strip-api"

  # 7. WEBSOCKET SERVICE
  websocket-service:
    image: tema1-websocket-service:v4
    depends_on:
      - postgres-db
      - rabbitmq
    environment:
      logging.level.org.springframework.web: DEBUG
      DB_IP: postgres-db
      DB_PORT: 5432
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-root}
      DB_DBNAME: websocket_db
      PORT: 8085
    networks:
      - microservice-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
          - "traefik.enable=true"

          - "traefik.http.routers.ws-socket.rule=PathPrefix(`/ws-energy`)"
          - "traefik.http.routers.ws-socket.service=websocket-service"
          - "traefik.http.routers.ws-socket.entrypoints=web"
          - "traefik.http.services.websocket-service.loadbalancer.server.port=8085"
  # 8. TRAEFIK (Reverse Proxy)
  traefik:
    image: traefik:v3.0
    command:
      # --- CONFIGURAȚIE NOUĂ PENTRU SWARM (v3) ---
      - "--providers.swarm=true"  # Activăm provider-ul specific de Swarm
      - "--providers.swarm.exposedbydefault=false" # Nu expunem totul automat
      - "--providers.swarm.network=ems_microservice-network" # Numele rețelei (prefixat cu ems_)

      # Entrypoints (Port 80)
      - "--entrypoints.web.address=:80"

      # Dashboard (Port 8080 intern -> 8090 extern)
      - "--api.dashboard=true"
      - "--api.insecure=true"

      # Logging (Opțional, ajută la debugging)
      - "--log.level=INFO"
    ports:
      - "80:80"     # Trafic web
      - "8090:8080" # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - microservice-network
    deploy:
      replicas: 1
      placement:
        constraints: [ node.role == manager ]
  # 9. SWAGGER UI
  swagger-ui:
    image: swaggerapi/swagger-ui
    ports:
      - "8088:8080" # Am schimbat portul extern ca să nu intre in conflict
    environment:
      SWAGGER_JSON: /api-docs.yaml
    volumes:
      - ./swagger/api-docs.yaml:/api-docs.yaml
    networks:
      - microservice-network
    deploy:
      replicas: 1
    # 11. FRONTEND SERVICE
  frontend:
      image: tema1-frontend:latest
      networks:
        - microservice-network
      deploy:
        replicas: 1
        labels:
          - "traefik.enable=true"
          - "traefik.http.routers.frontend.rule=PathPrefix(`/`)"
          - "traefik.http.routers.frontend.entrypoints=web"
          - "traefik.http.routers.frontend.priority=1"
          # ATENȚIE: Aici pui portul din vite.config.js (5173)
          - "traefik.http.services.frontend.loadbalancer.server.port=5173"

networks:
  microservice-network:
    driver: overlay # <--- IMPORTANT: Driverul devine Overlay în Swarm

volumes:
  db-data: